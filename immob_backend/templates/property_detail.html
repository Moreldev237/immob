{% extends 'base.html' %}
{% load static %}

{% block title %}Détails de la propriété - IMMOB{% endblock %}

{% block content %}
<div id="property-detail" class="min-h-screen">
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-600">Chargement...</p>
        </div>
    </div>

    <div id="property-content" class="hidden">
        <!-- Image Gallery -->
        <div class="relative bg-gray-900">
            <div class="container mx-auto">
                <div class="grid grid-cols-4 gap-2 p-2">
                    <div class="col-span-2 row-span-2">
                        <a href="#" id="main-image-link" data-lightbox="gallery" data-title="">
                            <div id="main-image" class="w-full h-[400px] bg-gray-200 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-image text-6xl text-gray-400"></i>
                            </div>
                        </a>
                    </div>
                    <div><a href="#" id="thumb-0" data-lightbox="gallery"><img src="" class="w-full h-[198px] object-cover cursor-pointer hover:opacity-80"></a></div>
                    <div><a href="#" id="thumb-1" data-lightbox="gallery"><img src="" class="w-full h-[198px] object-cover cursor-pointer hover:opacity-80"></a></div>
                    <div><a href="#" id="thumb-2" data-lightbox="gallery"><img src="" class="w-full h-[198px] object-cover cursor-pointer hover:opacity-80"></a></div>
                    <div><a href="#" id="thumb-3" data-lightbox="gallery"><img src="" class="w-full h-[198px] object-cover cursor-pointer hover:opacity-80"></a></div>
                </div>
                
                <div class="absolute bottom-4 right-4 flex space-x-2">
                    <button id="share-property-btn" class="bg-white px-4 py-2 rounded-lg shadow hover:bg-gray-100">
                        <i class="fas fa-share mr-2"></i>Partager
                    </button>
                    <button id="save-property-btn" class="bg-white px-4 py-2 rounded-lg shadow hover:bg-gray-100">
                        <i class="far fa-heart mr-2"></i>Sauvegarder
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h1 id="property-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                                <p id="property-location" class="text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i></p>
                            </div>
                            <div class="text-right">
                                <div id="property-price" class="text-3xl font-bold text-blue-600"></div>
                                <span id="property-status" class="inline-block bg-blue-600 text-white px-3 py-1 rounded-full font-bold text-sm mt-2"></span>
                            </div>
                        </div>
                        
                        <div id="property-features" class="grid grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg"></div>
                        
                        <div class="mt-4 flex items-center">
                            <div class="flex text-yellow-400 text-lg">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i>
                                <i class="fas fa-star"></i><i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </div>
                            <span class="ml-2 font-bold" id="rating-value">0</span>
                            <span class="ml-1 text-gray-500">(<span id="review-count">0</span> avis)</span>
                            <span class="mx-2 text-gray-300">|</span>
                            <span class="text-gray-500"><i class="fas fa-eye mr-1"></i><span id="views-count">0</span> vues</span>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">Description</h2>
                        <div id="property-description" class="text-gray-700 leading-relaxed"></div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">Équipements & Commodités</h2>
                        <div id="property-amenities" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">Localisation</h2>
                        <div id="property-map" class="h-[350px] rounded-lg shadow-lg mb-4"></div>
                        <div id="property-address" class="text-gray-600"></div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">Détails</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <span class="text-gray-500 text-sm">Type</span>
                                <p id="detail-type" class="font-bold"></p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <span class="text-gray-500 text-sm">Superficie</span>
                                <p id="detail-area" class="font-bold"></p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Avis</h2>
                            <button id="write-review-btn" class="btn-primary">Écrire un avis</button>
                        </div>
                        <div id="property-reviews"><p class="text-gray-500">Chargement...</p></div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-lg sticky top-24">
                        <h3 class="text-lg font-bold mb-4">Planifier une visite</h3>
                        <form id="visit-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Date</label>
                                <input type="text" id="visit-date" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Choisir une date">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Heure</label>
                                <select id="visit-time" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="">Sélectionner</option>
                                    <option value="09:00">09:00 - 10:00</option>
                                    <option value="10:00">10:00 - 11:00</option>
                                    <option value="14:00">14:00 - 15:00</option>
                                    <option value="15:00">15:00 - 16:00</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Nom</label>
                                <input type="text" id="visit-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Téléphone</label>
                                <input type="tel" id="visit-phone" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Message</label>
                                <textarea id="visit-message" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold">
                                <i class="fas fa-calendar-check mr-2"></i>Demander une visite
                            </button>
                        </form>
                        <div class="mt-4 pt-4 border-t">
                            <button id="call-agent" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold">
                                <i class="fas fa-phone mr-2"></i>Appeler l'agent
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                        <h3 class="text-lg font-bold mb-4">Agent</h3>
                        <div class="flex items-center mb-4">
                            <img id="agent-avatar" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100" class="w-16 h-16 rounded-full mr-4">
                            <div>
                                <div id="agent-name" class="font-bold">Chargement...</div>
                                <div id="agent-agency" class="text-sm text-gray-500"></div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p><i class="fas fa-phone mr-2"></i><span id="agent-phone"></span></p>
                            <p><i class="fas fa-envelope mr-2"></i><span id="agent-email"></span></p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                        <h3 class="text-lg font-bold mb-4">Similaires</h3>
                        <div id="similar-properties" class="space-y-4"><p class="text-gray-500 text-sm">Chargement...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="share-modal" class="modal">
    <div class="modal-content max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Partager</h3>
            <button class="close-modal text-2xl text-gray-500">&times;</button>
        </div>
        <div class="flex justify-center space-x-4 mb-6">
            <a href="#" id="share-facebook" class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center"><i class="fab fa-facebook-f"></i></a>
            <a href="#" id="share-twitter" class="w-12 h-12 rounded-full bg-blue-400 text-white flex items-center justify-center"><i class="fab fa-twitter"></i></a>
            <a href="#" id="share-whatsapp" class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center"><i class="fab fa-whatsapp"></i></a>
            <a href="#" id="share-email" class="w-12 h-12 rounded-full bg-gray-600 text-white flex items-center justify-center"><i class="fas fa-envelope"></i></a>
        </div>
        <div class="flex">
            <input type="text" id="share-url" readonly class="flex-1 p-3 border border-gray-300 rounded-l-lg bg-gray-50" value="">
            <button id="copy-url" class="bg-blue-600 text-white px-4 rounded-r-lg">Copier</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const propertyId = '{{ property_id }}';
    const loading = document.getElementById('loading');
    const content = document.getElementById('property-content');
    const shareModal = document.getElementById('share-modal');
    
    loadPropertyDetails();
    initDatePicker();
    initModals();
    
    async function loadPropertyDetails() {
        try {
            const response = await fetch(`/api/properties/${propertyId}/`);
            const property = await response.json();
            displayPropertyDetails(property);
            loading.style.display = 'none';
            content.classList.remove('hidden');
            loadPropertyReviews(propertyId);
            loadSimilarProperties(property);
        } catch (error) {
            loading.innerHTML = '<div class="text-center"><p class="text-red-600">Erreur</p></div>';
        }
    }
    
    function displayPropertyDetails(property) {
        document.getElementById('property-title').textContent = property.title;
        document.getElementById('property-location').innerHTML = `<i class="fas fa-map-marker-alt mr-1"></i>${property.location?.city || ''}${property.location?.quarter ? ', ' + property.location.quarter : ''}`;
        
        const status = getPropertyStatus(property.status);
        document.getElementById('property-status').textContent = status.text;
        document.getElementById('property-price').textContent = `${formatPrice(property.price, property.currency)}${property.status === 'for_rent' ? '/mois' : ''}`;
        
        const featuresContainer = document.getElementById('property-features');
        featuresContainer.innerHTML = `
            ${property.bedrooms > 0 ? `<div class="text-center"><i class="fas fa-bed text-2xl text-gray-600 mb-1"></i><div class="font-bold text-lg">${property.bedrooms}</div><div class="text-xs text-gray-500">Chambres</div></div>` : ''}
            ${property.bathrooms > 0 ? `<div class="text-center"><i class="fas fa-bath text-2xl text-gray-600 mb-1"></i><div class="font-bold text-lg">${property.bathrooms}</div><div class="text-xs text-gray-500">SDB</div></div>` : ''}
            ${property.area > 0 ? `<div class="text-center"><i class="fas fa-ruler-combined text-2xl text-gray-600 mb-1"></i><div class="font-bold text-lg">${property.area}</div><div class="text-xs text-gray-500">m²</div></div>` : ''}
            ${property.parking_spaces > 0 ? `<div class="text-center"><i class="fas fa-car text-2xl text-gray-600 mb-1"></i><div class="font-bold text-lg">${property.parking_spaces}</div><div class="text-xs text-gray-500">Parking</div></div>` : ''}
        `;
        
        document.getElementById('rating-value').textContent = property.average_rating || '0';
        document.getElementById('review-count').textContent = property.review_count || '0';
        document.getElementById('views-count').textContent = property.views_count || '0';
        document.getElementById('property-description').textContent = property.description;
        document.getElementById('detail-type').textContent = property.property_type?.name || 'Non spécifié';
        document.getElementById('detail-area').textContent = property.area ? `${property.area} m²` : 'Non spécifié';
        document.getElementById('property-address').textContent = property.location?.address || '';
        
        const amenities = [];
        if (property.has_kitchen) amenities.push('<div class="flex items-center"><i class="fas fa-utensils text-blue-500 mr-2"></i>Cuisine</div>');
        if (property.has_balcony) amenities.push('<div class="flex items-center"><i class="fas fa-arch text-amber-500 mr-2"></i>Balcon</div>');
        if (property.has_garden) amenities.push('<div class="flex items-center"><i class="fas fa-tree text-green-500 mr-2"></i>Jardin</div>');
        if (property.has_pool) amenities.push('<div class="flex items-center"><i class="fas fa-swimming-pool text-blue-400 mr-2"></i>Piscine</div>');
        if (property.has_security) amenities.push('<div class="flex items-center"><i class="fas fa-shield-alt text-green-500 mr-2"></i>Sécurité</div>');
        if (property.has_internet) amenities.push('<div class="flex items-center"><i class="fas fa-wifi text-blue-500 mr-2"></i>Internet</div>');
        if (property.has_ac) amenities.push('<div class="flex items-center"><i class="fas fa-snowflake text-blue-400 mr-2"></i>Climatisation</div>');
        document.getElementById('property-amenities').innerHTML = amenities.join('') || '<p class="text-gray-500">Aucune</p>';
        
        updateImageGallery(property);
        initPropertyMap(property);
        updateAgentInfo(property);
        document.getElementById('share-url').value = window.location.href;
        updateShareLinks(property);
    }
    
    function updateImageGallery(property) {
        const images = property.images || [];
        const mainImage = document.getElementById('main-image');
        const mainLink = document.getElementById('main-image-link');
        
        if (images.length > 0) {
            mainImage.innerHTML = `<img src="${images[0].image}" class="w-full h-full object-cover">`;
            mainLink.href = images[0].image;
            for (let i = 1; i < Math.min(images.length, 5); i++) {
                const thumb = document.getElementById(`thumb-${i-1}`);
                if (thumb) {
                    thumb.href = images[i].image;
                    thumb.querySelector('img').src = images[i].image;
                }
            }
        }
    }
    
    function initPropertyMap(property) {
        if (!property.location?.latitude || !property.location?.longitude) return;
        const mapContainer = document.getElementById('property-map');
        if (!mapContainer) return;
        
        const map = L.map(mapContainer).setView([property.location.latitude, property.location.longitude], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        L.marker([property.location.latitude, property.location.longitude]).addTo(map).bindPopup(property.title).openPopup();
    }
    
    function updateAgentInfo(property) {
        if (property.agent) {
            document.getElementById('agent-name').textContent = `${property.agent.first_name} ${property.agent.last_name}`;
            document.getElementById('agent-agency').textContent = property.agent.agency_name || 'Agent';
            document.getElementById('agent-phone').textContent = property.agent.phone_number || 'N/A';
            document.getElementById('agent-email').textContent = property.agent.email;
            if (property.agent.profile_picture) document.getElementById('agent-avatar').src = property.agent.profile_picture;
        } else {
            document.getElementById('agent-name').textContent = 'Propriétaire';
            document.getElementById('agent-email').textContent = property.owner?.email || '';
        }
    }
    
    function initDatePicker() {
        flatpickr('#visit-date', { minDate: 'today', dateFormat: 'd/m/Y', locale: 'fr', disable: [date => date.getDay() === 0] });
    }
    
    function initModals() {
        document.getElementById('share-property-btn')?.addEventListener('click', () => shareModal.style.display = 'block');
        document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => shareModal.style.display = 'none'));
        window.addEventListener('click', e => { if (e.target === shareModal) shareModal.style.display = 'none'; });
        
        document.getElementById('copy-url')?.addEventListener('click', function() {
            const input = document.getElementById('share-url');
            input.select();
            document.execCommand('copy');
            showToast('Lien copié !', 'success');
        });
    }
    
    function updateShareLinks(property) {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(property.title);
        document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
        document.getElementById('share-whatsapp').href = `https://wa.me/?text=${title} ${url}`;
        document.getElementById('share-email').href = `mailto:?subject=${title}&body=${url}`;
    }
    
    async function loadPropertyReviews(propertyId) {
        const container = document.getElementById('property-reviews');
        try {
            const response = await fetch(`/api/properties/${propertyId}/reviews/`);
            const reviews = await response.json();
            if (reviews.length === 0) { container.innerHTML = '<p class="text-gray-500">Aucun avis</p>'; return; }
            container.innerHTML = reviews.map(review => `
                <div class="border-b border-gray-200 pb-4 mb-4">
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center mr-3">
                            <span class="font-bold text-blue-700">${review.user?.first_name?.[0] || 'A'}</span>
                        </div>
                        <div><div class="font-bold">${review.user?.first_name || 'Anonyme'}</div>
                        <div class="flex text-yellow-400 text-sm">${'<i class="fas fa-star"></i>'.repeat(review.rating)}${'<i class="far fa-star"></i>'.repeat(5 - review.rating)}</div></div>
                    </div>
                    <p class="text-gray-700">${review.comment}</p>
                </div>
            `).join('');
        } catch (error) { container.innerHTML = '<p class="text-gray-500">Erreur</p>'; }
    }
    
    async function loadSimilarProperties(property) {
        const container = document.getElementById('similar-properties');
        try {
            const response = await fetch(`/api/properties/?property_type=${property.property_type?.id || ''}&limit=3`);
            const data = await response.json();
            const similar = (data.results || data).filter(p => p.id !== property.id).slice(0, 3);
            if (similar.length === 0) { container.innerHTML = '<p class="text-gray-500 text-sm">Aucune</p>'; return; }
            container.innerHTML = similar.map(p => `
                <a href="/properties/${p.id}/" class="flex space-x-3 p-2 rounded-lg hover:bg-gray-50">
                    <img src="${p.images?.[0]?.image || ''}" class="w-16 h-16 rounded-lg object-cover">
                    <div class="flex-1"><p class="font-bold text-sm line-clamp-1">${p.title}</p>
                    <p class="text-blue-600 font-bold text-sm">${formatPrice(p.price, p.currency)}</p></div>
                </a>
            `).join('');
        } catch (error) { container.innerHTML = '<p class="text-gray-500 text-sm">Erreur</p>'; }
    }
    
    document.getElementById('visit-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = { property_id: propertyId, date: document.getElementById('visit-date').value, time: document.getElementById('visit-time').value, name: document.getElementById('visit-name').value, phone: document.getElementById('visit-phone').value, message: document.getElementById('visit-message').value };
        try {
            const response = await fetch('/api/visits/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
            if (response.ok) { showToast('Demande envoyée !', 'success'); this.reset(); }
            else { showToast('Erreur', 'error'); }
        } catch (error) { showToast('Erreur réseau', 'error'); }
    });
});
</script>
{% endblock %}

